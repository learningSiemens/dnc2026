<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DNC Siemens</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Estilos personalizados adicionales si son necesarios */
        body { font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        [x-cloak] { display: none !important; }
        .tab-active { background-color: white; color: #2563eb; border-color: #e2e8f0; border-bottom-color: white; z-index: 10; }
        .tab-inactive { color: #64748b; }
        .tab-inactive:hover { color: #334155; background-color: #f8fafc; }
    </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900 pb-10">

    <!-- HEADER MODERNO -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-xl text-white shadow-lg shadow-blue-200">
                        <i data-lucide="book-open" class="h-6 w-6"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-slate-800">Dashboard DNC Siemens</h1>
                        <p class="text-xs text-slate-500 font-medium">Learning & Growth South America 2026</p>
                    </div>
                </div>
                
                <!-- BARRA DE FILTROS INTEGRADA -->
                <div id="filterBar" class="flex flex-wrap gap-4 items-end w-full md:w-auto">
                    <!-- FILTRO EMPRESA -->
                    <div class="flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Empresa</label>
                        <div class="relative group">
                            <i data-lucide="briefcase" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                            <select id="filterCompany" class="pl-9 pr-8 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none hover:bg-white transition-colors cursor-pointer w-full md:w-48">
                                <option value="Todas">Todas</option>
                            </select>
                        </div>
                    </div>

                    <!-- FILTRO MANAGER -->
                    <div class="flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1">Manager</label>
                        <div class="relative group">
                            <i data-lucide="user" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400 group-hover:text-blue-500 transition-colors"></i>
                            <select id="filterManager" class="pl-9 pr-8 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none transition-colors cursor-pointer w-full md:w-56 bg-slate-50 border-slate-200">
                                <option value="Todos">Todos</option>
                            </select>
                        </div>
                    </div>

                    <!-- BOTÓN LIMPIAR -->
                    <button id="btnClearFilters" class="hidden mb-2 text-xs text-red-500 font-medium hover:underline hover:text-red-700 transition-colors px-2">
                        Limpiar Filtros
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- SKELETON (LOADING) -->
        <div id="loadingSkeleton" class="space-y-6 animate-pulse">
            <div class="h-24 bg-white rounded-2xl"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
               <div class="h-32 bg-white rounded-2xl"></div>
               <div class="h-32 bg-white rounded-2xl"></div>
               <div class="h-32 bg-white rounded-2xl"></div>
            </div>
            <div class="h-96 bg-white rounded-2xl"></div>
        </div>

        <!-- MENSAJE DE ERROR -->
        <div id="errorMessage" class="hidden mb-6 bg-red-50 border border-red-200 p-4 rounded-xl text-red-700 flex items-start gap-3 shadow-sm">
            <i data-lucide="alert-circle" class="h-5 w-5 mt-0.5 shrink-0"></i>
            <div>
                <p class="font-bold text-sm">Error de conexión</p>
                <p id="errorText" class="text-xs opacity-90"></p>
            </div>
        </div>

        <!-- CONTENIDO PRINCIPAL (OCULTO MIENTRAS CARGA) -->
        <div id="mainContent" class="hidden">
            
            <!-- TABS NAVEGACIÓN -->
            <div class="flex gap-2 mb-6 border-b border-slate-200 pb-1">
                <button onclick="changeTab('dashboard')" id="tab-dashboard" class="tab-btn tab-active flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-all relative top-[1px] border">
                    <i data-lucide="bar-chart-3" class="h-4 w-4"></i> Dashboard
                </button>
                <button onclick="changeTab('table')" id="tab-table" class="tab-btn tab-inactive flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-all relative top-[1px] border border-transparent">
                    <i data-lucide="list" class="h-4 w-4"></i> Base de Datos
                </button>
                <button onclick="changeTab('courses')" id="tab-courses" class="tab-btn tab-inactive flex items-center gap-2 px-4 py-2 text-sm font-medium rounded-t-lg transition-all relative top-[1px] border border-transparent">
                    <i data-lucide="search" class="h-4 w-4"></i> Detalle Cursos
                </button>
                <div class="flex-1 text-right">
                    <button onclick="handleExport()" class="inline-flex items-center gap-1 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 px-3 py-1.5 rounded-lg transition-colors border border-green-200">
                        <i data-lucide="download" class="h-3 w-3"></i> Exportar Excel
                    </button>
                </div>
            </div>

            <!-- VISTA: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6">
                <!-- SECCIÓN KPI REACTIVA -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- CARD 1: CONTEXTUAL -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between h-full relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        
                        <!-- Vista Global -->
                        <div id="kpiGlobalContext">
                            <div class="flex justify-between items-start relative z-10">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Status Encuesta</p>
                                    <div class="flex items-baseline gap-1 mt-1">
                                        <h3 id="kpiManagersResponded" class="text-2xl font-bold text-slate-800">0</h3>
                                        <span class="text-sm text-slate-400 font-medium">/ <span id="kpiTotalManagersTarget">37</span></span>
                                        <button onclick="toggleEditTarget()" class="ml-1 text-slate-300 hover:text-blue-500"><i data-lucide="edit-2" class="h-3 w-3"></i></button>
                                    </div>
                                </div>
                                <div class="p-2 bg-blue-100 text-blue-600 rounded-lg shadow-sm"><i data-lucide="user-check" class="h-5 w-5"></i></div>
                            </div>
                            <!-- Input para editar target -->
                            <div id="editTargetContainer" class="hidden mt-2 flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                <span class="text-xs text-slate-500">Total:</span>
                                <input type="number" id="inputTarget" class="w-16 text-sm border rounded px-1 py-0.5" />
                                <button onclick="saveTarget()" class="text-green-600"><i data-lucide="check" class="h-4 w-4"></i></button>
                            </div>
                            <!-- Barra de progreso -->
                            <div class="w-full mt-2">
                                <div class="flex justify-between text-xs mb-1 font-medium text-slate-500">
                                    <span>Progreso Encuesta</span>
                                    <span id="progressBarPercentageText">0%</span>
                                </div>
                                <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden">
                                    <div id="progressBarFill" class="bg-gradient-to-r from-blue-500 to-blue-400 h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-xs mt-1 text-slate-400">
                                    <span>0</span>
                                    <span><span id="progressBarTotal">37</span> Managers</span>
                                </div>
                            </div>
                        </div>

                        <!-- Vista Manager -->
                        <div id="kpiManagerContext" class="hidden">
                            <div class="flex justify-between items-start relative z-10">
                                <div>
                                    <p class="text-xs font-bold text-blue-500 uppercase tracking-wider">Mi Equipo</p>
                                    <h3 id="kpiTeamSize" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                                    <p class="text-xs text-slate-400 mt-1">Colaboradores únicos</p>
                                </div>
                                <div class="p-2 bg-blue-100 text-blue-600 rounded-lg shadow-sm"><i data-lucide="users" class="h-5 w-5"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD 2: TOTAL SOLICITUDES -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between h-full relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-emerald-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                        <div class="flex justify-between items-start relative z-10">
                            <div>
                                <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Solicitudes Totales</p>
                                <h3 id="kpiTotalRequests" class="text-3xl font-bold text-slate-800 mt-2">0</h3>
                                <p class="text-xs text-emerald-600 font-medium mt-1 flex items-center gap-1">
                                    <i data-lucide="trending-up" class="h-3 w-3"></i>
                                    <span id="kpiTotalRequestsContext">Cursos solicitados</span>
                                </p>
                            </div>
                            <div class="p-2 bg-emerald-100 text-emerald-600 rounded-lg shadow-sm"><i data-lucide="list" class="h-5 w-5"></i></div>
                        </div>
                    </div>

                    <!-- CARD 3: CURSO TOP -->
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex flex-col justify-between h-full md:col-span-2 relative overflow-hidden">
                        <div class="absolute bottom-0 right-0 w-32 h-32 bg-amber-50 rounded-tl-full -mr-6 -mb-6 opacity-50 pointer-events-none"></div>
                        <div class="flex justify-between items-start relative z-10 mb-2">
                            <div>
                                <p class="text-xs font-bold text-amber-500 uppercase tracking-wider flex items-center gap-1">
                                    <i data-lucide="target" class="h-3 w-3"></i>
                                    <span id="kpiTopCourseTitle">Necesidad #1 Global</span>
                                </p>
                            </div>
                            <div class="p-1.5 bg-amber-100 text-amber-600 rounded-lg"><i data-lucide="book-open" class="h-4 w-4"></i></div>
                        </div>

                        <div id="kpiTopCourseData" class="relative z-10">
                            <h3 id="kpiTopCourseName" class="text-lg font-bold text-slate-800 leading-tight mb-2 line-clamp-1">N/A</h3>
                            <div class="flex items-center gap-4">
                                <div class="flex flex-col">
                                    <span id="kpiTopCourseCount" class="text-2xl font-bold text-slate-700">0</span>
                                    <span class="text-[10px] text-slate-400 uppercase font-bold">Solicitudes</span>
                                </div>
                                <div class="h-8 w-px bg-slate-200"></div>
                                <div class="text-xs text-slate-500">
                                    Representa el <span id="kpiTopCoursePercentage" class="font-bold text-slate-700">0%</span> de la demanda <span id="kpiTopCourseContext">total</span>.
                                </div>
                            </div>
                        </div>
                        <div id="kpiTopCourseEmpty" class="hidden flex items-center justify-center h-full text-slate-400 text-sm italic">
                            Sin datos suficientes
                        </div>
                    </div>
                </div>

                <!-- GRÁFICOS -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- CHART PRINCIPAL -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-800 flex items-center gap-2">
                                <i data-lucide="bar-chart-3" class="h-5 w-5 text-blue-500"></i>
                                Top 10 Cursos Solicitados (P1)
                            </h3>
                            <span id="chartFilterBadge" class="hidden text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded-full font-medium">Filtrado</span>
                        </div>
                        <div class="h-[350px] w-full relative">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>

                    <!-- CHART SECUNDARIO -->
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 lg:col-span-1 flex flex-col">
                        <h3 class="font-bold text-slate-800 mb-2 text-center">Modalidad Preferida</h3>
                        <div class="flex-1 flex items-center justify-center min-h-[300px] relative">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VISTA: TABLA BASE DE DATOS -->
            <div id="view-table" class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left text-slate-500">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                            <tr>
                                <th class="px-6 py-4">Empresa</th>
                                <th class="px-6 py-4">Nombre Colaborador</th>
                                <th class="px-6 py-4">RUT</th>
                                <th class="px-6 py-4">Cursos Priorizados</th>
                                <th class="px-6 py-4">Supervisor</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody">
                            <!-- Filas generadas por JS -->
                        </tbody>
                    </table>
                </div>
                <!-- Paginación -->
                <div id="mainTablePagination" class="flex items-center justify-between px-6 py-4 border-t bg-slate-50"></div>
            </div>

            <!-- VISTA: DETALLE CURSOS -->
            <div id="view-courses" class="hidden space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <label class="text-sm font-bold text-slate-700 mb-2 block">Selecciona un Curso para ver detalles</label>
                    <div class="relative">
                        <i data-lucide="book-open" class="absolute left-3 top-3 h-5 w-5 text-slate-400"></i>
                        <select id="courseSelect" class="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-base focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="">-- Seleccionar curso --</option>
                            <!-- Opciones generadas por JS -->
                        </select>
                    </div>
                </div>

                <div id="courseDetailsContainer" class="hidden bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800 flex items-center gap-2">
                            <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Curso</span>
                            <span id="courseDetailsName">Nombre del curso</span>
                        </h3>
                        <span id="courseDetailsCount" class="text-sm font-medium text-slate-500">0 Interesados</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-3">Prioridad</th>
                                    <th class="px-6 py-3">Empresa</th>
                                    <th class="px-6 py-3">Colaborador</th>
                                    <th class="px-6 py-3">Supervisor</th>
                                </tr>
                            </thead>
                            <tbody id="courseTableBody">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Paginación -->
                    <div id="courseTablePagination" class="flex items-center justify-between px-6 py-4 border-t bg-slate-50"></div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // === CONFIGURACIÓN GLOBAL ===
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTswu_UFbR0oMXr-CVN1dLfEEpB1UNUH2dhEHFxhw40E4gNO-Yt1EJYTE0z5DRwaFniA/exec';
        const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6', '#f43f5e', '#64748b'];
        const COLOR_GRAY = '#cbd5e1';
        const ITEMS_PER_PAGE = 10;

        // === ESTADO DE LA APLICACIÓN ===
        const state = {
            rawData: [],
            processedData: [],
            courseViewData: [],
            activeTab: 'dashboard',
            filterCompany: 'Todas',
            filterManager: 'Todos',
            totalManagersTarget: 37,
            selectedCourseTab: '',
            currentPage: 1,
            stats: {}
        };

        // Instancias de Chart.js
        let barChartInstance = null;
        let pieChartInstance = null;

        // === INICIALIZACIÓN ===
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            setupEventListeners();
            fetchData();
        });

        // === OBTENCIÓN Y NORMALIZACIÓN DE DATOS ===
        async function fetchData() {
            document.getElementById('loadingSkeleton').classList.remove('hidden');
            document.getElementById('mainContent').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            try {
                const response = await fetch(SCRIPT_URL);
                if (!response.ok) throw new Error("No se pudo conectar al script de Google Sheets.");
                const json = await response.json();

                if (Array.isArray(json)) {
                    state.rawData = json.map(item => {
                        const newItem = { ...item };
                        Object.keys(item).forEach(key => {
                            const cleanKey = key.trim().toLowerCase();
                            
                            if (cleanKey === 'nombre del supervisor' || cleanKey === 'supervisor' || cleanKey.includes('nombre supervisor')) {
                                newItem['Supervisor'] = item[key];
                            } else if (cleanKey === 'rut colaborador' || cleanKey === 'rut' || cleanKey === 'run') {
                                newItem['RUT Colaborador'] = item[key];
                            } else if (cleanKey === 'nombre colaborador' || cleanKey === 'colaborador' || cleanKey === 'nombre completo') {
                                newItem['Colaborador'] = item[key];
                            } else if (cleanKey === 'empresa' || cleanKey === 'razon social') {
                                newItem['Empresa'] = item[key];
                            } else if (cleanKey.includes('rut') && cleanKey.includes('evaluador')) {
                                newItem['RUT Evaluador'] = item[key];
                            } else if (cleanKey === 'area' || cleanKey === 'área') {
                                newItem['Area'] = item[key];
                            } else if (cleanKey === 'cargo') {
                                newItem['Cargo'] = item[key];
                            } else if (cleanKey.includes('prioridad 1')) {
                                newItem['Curso Prioridad 1'] = item[key];
                            } else if (cleanKey.includes('prioridad 2')) {
                                newItem['Curso Prioridad 2'] = item[key];
                            } else if (cleanKey.includes('prioridad 3')) {
                                newItem['Curso Prioridad 3'] = item[key];
                            } else if (cleanKey.includes('modalidad') || cleanKey.includes('formato') || cleanKey.includes('preferida')) {
                                newItem['Modalidad'] = item[key];
                            }
                        });
                        return newItem;
                    }).filter(item => item['Colaborador'] && String(item['Colaborador']).trim() !== '');

                    populateFilters();
                    processData();
                } else {
                    throw new Error("El formato de los datos no es válido.");
                }
            } catch (err) {
                console.error(err);
                document.getElementById('errorMessage').classList.remove('hidden');
                document.getElementById('errorText').innerText = err.message;
            } finally {
                document.getElementById('loadingSkeleton').classList.add('hidden');
                if (state.rawData.length > 0) {
                    document.getElementById('mainContent').classList.remove('hidden');
                }
            }
        }

        // === PROCESAMIENTO DE DATOS ===
        function processData() {
            // Filtrar datos
            state.processedData = state.rawData.filter(item => {
                const matchCompany = state.filterCompany === 'Todas' || (item['Empresa'] && item['Empresa'].trim() === state.filterCompany);
                const matchManager = state.filterManager === 'Todos' || item['Supervisor'] === state.filterManager;
                return matchCompany && matchManager;
            });

            calculateStats();
            renderUI();
        }

        function calculateStats() {
            // Métricas globales
            const allUniqueSupervisors = new Set(state.rawData.map(d => d['RUT Evaluador'] || d['Supervisor']).filter(Boolean));
            const globalManagersResponded = allUniqueSupervisors.size;

            // Métricas contextuales
            const totalRequests = state.processedData.length;
            const uniqueCollaborators = new Set(state.processedData.map(d => d['Colaborador'])).size;
            
            const courseCountsP1 = {};
            state.processedData.forEach(d => {
                if(d['Curso Prioridad 1']) {
                    courseCountsP1[d['Curso Prioridad 1']] = (courseCountsP1[d['Curso Prioridad 1']] || 0) + 1;
                }
            });
            
            const sortedTopCourses = Object.entries(courseCountsP1)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 10);

            const modalityCounts = {};
            state.processedData.forEach(d => {
                let mod = d['Modalidad'];
                if (mod) {
                    mod = String(mod).trim();
                    mod = mod.charAt(0).toUpperCase() + mod.slice(1).toLowerCase();
                } else {
                    mod = 'Sin Información';
                }
                modalityCounts[mod] = (modalityCounts[mod] || 0) + 1;
            });

            const sortedModalities = Object.entries(modalityCounts)
                .map(([name, value]) => ({ name, value }))
                .sort((a, b) => b.value - a.value);

            state.stats = {
                global: { managersResponded: globalManagersResponded },
                context: {
                    totalRequests,
                    teamSize: uniqueCollaborators,
                    avgRequests: uniqueCollaborators > 0 ? (totalRequests / uniqueCollaborators).toFixed(1) : 0,
                    topCourse: sortedTopCourses.length > 0 ? sortedTopCourses[0] : null
                },
                charts: {
                    topCourses: sortedTopCourses,
                    modalities: sortedModalities
                }
            };
        }

        function processCourseData() {
            if (!state.selectedCourseTab) {
                state.courseViewData = [];
                return;
            }
            state.courseViewData = state.rawData.filter(row => 
                row['Curso Prioridad 1'] === state.selectedCourseTab || 
                row['Curso Prioridad 2'] === state.selectedCourseTab || 
                row['Curso Prioridad 3'] === state.selectedCourseTab
            ).map(row => {
                let priority = '';
                if (row['Curso Prioridad 1'] === state.selectedCourseTab) priority = 'P1';
                else if (row['Curso Prioridad 2'] === state.selectedCourseTab) priority = 'P2';
                else if (row['Curso Prioridad 3'] === state.selectedCourseTab) priority = 'P3';
                return { ...row, foundPriority: priority };
            }).sort((a, b) => a.foundPriority.localeCompare(b.foundPriority));
        }

        // === RENDERIZADO DE UI ===
        function renderUI() {
            updateKPIs();
            renderCharts();
            renderMainTable();
            if (state.activeTab === 'courses') {
                processCourseData();
                renderCourseDetails();
            }

            // Actualizar UI de filtros
            const filterManagerEl = document.getElementById('filterManager');
            if (state.filterManager !== 'Todos') {
                filterManagerEl.classList.add('bg-blue-50', 'border-blue-200', 'text-blue-700', 'font-medium');
                filterManagerEl.classList.remove('bg-slate-50', 'border-slate-200');
            } else {
                filterManagerEl.classList.remove('bg-blue-50', 'border-blue-200', 'text-blue-700', 'font-medium');
                filterManagerEl.classList.add('bg-slate-50', 'border-slate-200');
            }

            const btnClear = document.getElementById('btnClearFilters');
            if (state.filterManager !== 'Todos' || state.filterCompany !== 'Todas') {
                btnClear.classList.remove('hidden');
            } else {
                btnClear.classList.add('hidden');
            }

            lucide.createIcons();
        }

        function populateFilters() {
            const companies = new Set(state.rawData.map(d => d['Empresa']?.trim()).filter(Boolean));
            const managers = new Set(state.rawData.map(d => d['Supervisor']).filter(Boolean));
            const courses = new Set();
            
            state.rawData.forEach(row => {
                if (row['Curso Prioridad 1']) courses.add(row['Curso Prioridad 1']);
                if (row['Curso Prioridad 2']) courses.add(row['Curso Prioridad 2']);
                if (row['Curso Prioridad 3']) courses.add(row['Curso Prioridad 3']);
            });

            const selComp = document.getElementById('filterCompany');
            selComp.innerHTML = '<option value="Todas">Todas</option>';
            Array.from(companies).sort().forEach(c => selComp.innerHTML += `<option value="${c}">${c}</option>`);

            const selMan = document.getElementById('filterManager');
            selMan.innerHTML = '<option value="Todos">Todos</option>';
            Array.from(managers).sort().forEach(m => selMan.innerHTML += `<option value="${m}">${m}</option>`);

            const selCourse = document.getElementById('courseSelect');
            selCourse.innerHTML = '<option value="">-- Seleccionar curso --</option>';
            Array.from(courses).sort().forEach(c => selCourse.innerHTML += `<option value="${c}">${c}</option>`);
        }

        function updateKPIs() {
            // Contextual Logic (Global vs Manager)
            const kpiGlobal = document.getElementById('kpiGlobalContext');
            const kpiManager = document.getElementById('kpiManagerContext');
            
            if (state.filterManager === 'Todos') {
                kpiGlobal.classList.remove('hidden');
                kpiManager.classList.add('hidden');
                
                const responded = state.stats.global.managersResponded;
                const total = state.totalManagersTarget;
                const percentage = Math.min(100, Math.max(0, (responded / total) * 100));
                
                document.getElementById('kpiManagersResponded').innerText = responded;
                document.getElementById('kpiTotalManagersTarget').innerText = total;
                document.getElementById('progressBarPercentageText').innerText = `${Math.round(percentage)}%`;
                document.getElementById('progressBarFill').style.width = `${percentage}%`;
                document.getElementById('progressBarTotal').innerText = total;
                document.getElementById('inputTarget').value = total;
            } else {
                kpiGlobal.classList.add('hidden');
                kpiManager.classList.remove('hidden');
                document.getElementById('kpiTeamSize').innerText = state.stats.context.teamSize;
            }

            // Total Requests
            document.getElementById('kpiTotalRequests').innerText = state.stats.context.totalRequests;
            document.getElementById('kpiTotalRequestsContext').innerText = state.filterManager !== 'Todos' ? `${state.stats.context.avgRequests} por persona` : 'Cursos solicitados';

            // Top Course
            document.getElementById('kpiTopCourseTitle').innerText = state.filterManager === 'Todos' ? 'Necesidad #1 Global' : 'Necesidad #1 del Equipo';
            
            const topCourse = state.stats.context.topCourse;
            const dataContainer = document.getElementById('kpiTopCourseData');
            const emptyContainer = document.getElementById('kpiTopCourseEmpty');

            if (topCourse) {
                dataContainer.classList.remove('hidden');
                emptyContainer.classList.add('hidden');
                document.getElementById('kpiTopCourseName').innerText = topCourse.name;
                document.getElementById('kpiTopCourseName').title = topCourse.name;
                document.getElementById('kpiTopCourseCount').innerText = topCourse.count;
                
                const pct = state.stats.context.totalRequests > 0 ? Math.round((topCourse.count / state.stats.context.totalRequests) * 100) : 0;
                document.getElementById('kpiTopCoursePercentage').innerText = `${pct}%`;
                document.getElementById('kpiTopCourseContext').innerText = state.filterManager !== 'Todos' ? 'del equipo' : 'total';
            } else {
                dataContainer.classList.add('hidden');
                emptyContainer.classList.remove('hidden');
            }
        }

        function renderCharts() {
            // Badges UI
            const badge = document.getElementById('chartFilterBadge');
            if (state.filterManager !== 'Todos') {
                badge.innerText = `Filtrado por: ${state.filterManager}`;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }

            // --- Bar Chart (Top Courses) ---
            const ctxBar = document.getElementById('barChart').getContext('2d');
            const barData = state.stats.charts.topCourses;
            
            if (barChartInstance) barChartInstance.destroy();
            
            barChartInstance = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: barData.map(d => d.name),
                    datasets: [{
                        label: 'Solicitudes',
                        data: barData.map(d => d.count),
                        backgroundColor: barData.map((_, i) => COLORS[i % COLORS.length]),
                        borderRadius: 6,
                        barThickness: 20
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'white',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            displayColors: false,
                            callbacks: {
                                title: (ctx) => ctx[0].label,
                                label: (ctx) => `${ctx.raw} solicitudes`
                            }
                        }
                    },
                    scales: {
                        x: { display: false, grid: { display: false } },
                        y: {
                            grid: { display: false },
                            ticks: { 
                                font: { size: 11, weight: '500' },
                                color: '#64748b',
                                callback: function(value) {
                                    let label = this.getLabelForValue(value);
                                    return label.length > 30 ? label.substr(0, 30) + '...' : label;
                                }
                            }
                        }
                    }
                }
            });

            // --- Pie Chart (Modalities) ---
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            const pieData = state.stats.charts.modalities;

            if (pieChartInstance) pieChartInstance.destroy();

            pieChartInstance = new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: pieData.map(d => d.name),
                    datasets: [{
                        data: pieData.map(d => d.value),
                        backgroundColor: pieData.map((d, i) => d.name === 'Sin Información' ? COLOR_GRAY : COLORS[i % COLORS.length]),
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true } },
                        tooltip: {
                            backgroundColor: 'white',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // === TABLAS Y PAGINACIÓN ===
        function getEmptyStateHTML() {
            return `
            <tr><td colspan="5" class="px-6 py-12">
                <div class="flex flex-col items-center justify-center py-8 text-center bg-white rounded-2xl border-2 border-dashed border-slate-200 m-4">
                    <div class="bg-slate-50 p-4 rounded-full mb-4">
                        <i data-lucide="file-question" class="h-10 w-10 text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1">Sin resultados</h3>
                    <p class="text-slate-500 max-w-sm text-sm">No se encontraron datos con los filtros actuales.</p>
                </div>
            </td></tr>`;
        }

        function renderPaginationControls(totalItems, containerId) {
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const container = document.getElementById(containerId);
            
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const startIdx = (state.currentPage - 1) * ITEMS_PER_PAGE + 1;
            const endIdx = Math.min(state.currentPage * ITEMS_PER_PAGE, totalItems);

            container.innerHTML = `
                <span class="text-xs text-slate-500">${startIdx}-${endIdx} de ${totalItems}</span>
                <div class="flex items-center gap-1">
                    <button onclick="setPage(${Math.max(state.currentPage - 1, 1)})" ${state.currentPage === 1 ? 'disabled' : ''} class="p-1 rounded hover:bg-slate-200 disabled:opacity-50 transition-colors">
                        <i data-lucide="chevron-left" class="h-4 w-4"></i>
                    </button>
                    <span class="text-xs font-medium text-slate-700 mx-2">${state.currentPage} / ${totalPages}</span>
                    <button onclick="setPage(${Math.min(state.currentPage + 1, totalPages)})" ${state.currentPage === totalPages ? 'disabled' : ''} class="p-1 rounded hover:bg-slate-200 disabled:opacity-50 transition-colors">
                        <i data-lucide="chevron-right" class="h-4 w-4"></i>
                    </button>
                </div>
            `;
            lucide.createIcons();
        }

        function renderMainTable() {
            const tbody = document.getElementById('mainTableBody');
            if (state.processedData.length === 0) {
                tbody.innerHTML = getEmptyStateHTML();
                document.getElementById('mainTablePagination').innerHTML = '';
                lucide.createIcons();
                return;
            }

            const paginatedData = state.processedData.slice((state.currentPage - 1) * ITEMS_PER_PAGE, state.currentPage * ITEMS_PER_PAGE);
            
            tbody.innerHTML = paginatedData.map(row => `
                <tr class="bg-white border-b hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-semibold text-slate-800">${row['Empresa'] || '-'}</td>
                    <td class="px-6 py-4 font-bold text-slate-700">${row['Colaborador']}</td>
                    <td class="px-6 py-4 text-xs font-mono text-slate-500">${row['RUT Colaborador'] || '-'}</td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col gap-1.5 items-start">
                            ${row['Curso Prioridad 1'] ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-50 text-blue-700 border border-blue-100 max-w-[200px] truncate" title="${row['Curso Prioridad 1']}">P1: ${row['Curso Prioridad 1']}</span>` : ''}
                            ${row['Curso Prioridad 2'] ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-amber-50 text-amber-700 border border-amber-100 max-w-[200px] truncate" title="${row['Curso Prioridad 2']}">P2: ${row['Curso Prioridad 2']}</span>` : ''}
                            ${row['Curso Prioridad 3'] ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-emerald-50 text-emerald-700 border border-emerald-100 max-w-[200px] truncate" title="${row['Curso Prioridad 3']}">P3: ${row['Curso Prioridad 3']}</span>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 text-slate-500">${row['Supervisor'] || '-'}</td>
                </tr>
            `).join('');

            renderPaginationControls(state.processedData.length, 'mainTablePagination');
        }

        function renderCourseDetails() {
            const container = document.getElementById('courseDetailsContainer');
            if (!state.selectedCourseTab) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            document.getElementById('courseDetailsName').innerText = state.selectedCourseTab;
            document.getElementById('courseDetailsCount').innerText = `${state.courseViewData.length} Interesados`;

            const tbody = document.getElementById('courseTableBody');
            const paginatedData = state.courseViewData.slice((state.currentPage - 1) * ITEMS_PER_PAGE, state.currentPage * ITEMS_PER_PAGE);

            tbody.innerHTML = paginatedData.map(row => {
                let badgeClass = 'bg-emerald-100 text-emerald-700';
                if(row.foundPriority === 'P1') badgeClass = 'bg-red-100 text-red-700';
                if(row.foundPriority === 'P2') badgeClass = 'bg-amber-100 text-amber-700';

                return `
                <tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${row.foundPriority}</span>
                    </td>
                    <td class="px-6 py-4 font-medium text-slate-900">${row['Empresa'] || '-'}</td>
                    <td class="px-6 py-4">${row['Colaborador']}</td>
                    <td class="px-6 py-4 text-slate-500">${row['Supervisor'] || '-'}</td>
                </tr>
                `;
            }).join('');

            renderPaginationControls(state.courseViewData.length, 'courseTablePagination');
        }


        // === CONTROLADORES DE EVENTOS ===
        function setupEventListeners() {
            // Filtros
            document.getElementById('filterCompany').addEventListener('change', (e) => {
                state.filterCompany = e.target.value;
                state.currentPage = 1;
                processData();
            });

            document.getElementById('filterManager').addEventListener('change', (e) => {
                state.filterManager = e.target.value;
                state.currentPage = 1;
                processData();
            });

            document.getElementById('btnClearFilters').addEventListener('click', () => {
                state.filterCompany = 'Todas';
                state.filterManager = 'Todos';
                document.getElementById('filterCompany').value = 'Todas';
                document.getElementById('filterManager').value = 'Todos';
                state.currentPage = 1;
                processData();
            });

            // Selector de Curso
            document.getElementById('courseSelect').addEventListener('change', (e) => {
                state.selectedCourseTab = e.target.value;
                state.currentPage = 1;
                processCourseData();
                renderCourseDetails();
            });
        }

        // Funciones auxiliares globales
        window.changeTab = function(tabId) {
            state.activeTab = tabId;
            state.currentPage = 1;

            // Actualizar botones UI
            ['dashboard', 'table', 'courses'].forEach(id => {
                const btn = document.getElementById(`tab-${id}`);
                if (id === tabId) {
                    btn.classList.add('tab-active');
                    btn.classList.remove('tab-inactive', 'border-transparent');
                } else {
                    btn.classList.remove('tab-active');
                    btn.classList.add('tab-inactive', 'border-transparent');
                }
                
                // Mostrar/Ocultar vistas
                const view = document.getElementById(`view-${id}`);
                if(id === tabId) view.classList.remove('hidden');
                else view.classList.add('hidden');
            });

            // Lógica de visibilidad de barra de filtros
            const filterBar = document.getElementById('filterBar');
            if (tabId === 'courses') {
                filterBar.classList.add('hidden');
            } else {
                filterBar.classList.remove('hidden');
            }

            // Renderizar la vista activa
            if (tabId === 'dashboard') updateKPIs();
            if (tabId === 'table') renderMainTable();
            if (tabId === 'courses') {
                processCourseData();
                renderCourseDetails();
            }
        };

        window.setPage = function(pageNumber) {
            state.currentPage = pageNumber;
            if (state.activeTab === 'table') renderMainTable();
            if (state.activeTab === 'courses') renderCourseDetails();
        };

        window.toggleEditTarget = function() {
            const container = document.getElementById('editTargetContainer');
            container.classList.toggle('hidden');
        };

        window.saveTarget = function() {
            const inputVal = parseInt(document.getElementById('inputTarget').value);
            if (!isNaN(inputVal) && inputVal > 0) {
                state.totalManagersTarget = inputVal;
                updateKPIs();
            }
            document.getElementById('editTargetContainer').classList.add('hidden');
        };

        window.handleExport = function() {
            const dataToExport = state.activeTab === 'courses' ? state.courseViewData : state.processedData;
            if (!dataToExport || dataToExport.length === 0) {
                alert("No hay datos para exportar con los filtros actuales.");
                return;
            }
            
            const headers = Object.keys(dataToExport[0]);
            let tableHTML = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="UTF-8"></head><body><table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${dataToExport.map(r => `<tr>${headers.map(h => `<td>${r[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody></table></body></html>`;
            
            const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `DNC_Export_${new Date().getTime()}.xls`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };
    </script>
</body>
</html>
