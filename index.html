<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard DNC</title>
    
    <!-- Tailwind CSS para los estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js para las gráficas -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons para la iconografía -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Pequeños ajustes adicionales */
        .hidden { display: none !important; }
        [data-lucide] { display: inline-block; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans min-h-screen">

    <!-- HEADER -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-2xl font-bold flex items-center gap-2">
                        <i data-lucide="book-open" class="h-8 w-8 text-blue-300"></i>
                        Dashboard DNC
                    </h1>
                    <p class="text-blue-200 text-sm">Detección de Necesidades de Capacitación</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        
        <!-- MENSAJE DE ERROR -->
        <div id="errorContainer" class="hidden mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded text-red-700 flex items-start gap-3">
            <i data-lucide="alert-circle" class="h-5 w-5 mt-0.5"></i>
            <div>
                <p class="font-bold">Error de conexión</p>
                <p class="text-sm" id="errorMessage"></p>
            </div>
        </div>

        <!-- SKELETON LOADING -->
        <div id="skeletonLoader" class="space-y-6 animate-pulse hidden">
            <div class="flex flex-col xl:flex-row gap-4 justify-between bg-white p-4 rounded-xl border border-slate-100">
                <div class="flex gap-4 w-full xl:w-2/3">
                    <div class="h-10 bg-slate-200 rounded w-1/3"></div>
                    <div class="h-10 bg-slate-200 rounded w-1/3"></div>
                    <div class="h-10 bg-slate-200 rounded w-1/3"></div>
                </div>
                <div class="flex gap-2 w-full xl:w-auto">
                    <div class="h-10 bg-slate-200 rounded w-24"></div>
                    <div class="h-10 bg-slate-200 rounded w-24"></div>
                    <div class="h-10 bg-slate-200 rounded w-24"></div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-6 rounded-xl border border-slate-100 h-32"></div>
                <div class="bg-white p-6 rounded-xl border border-slate-100 h-32"></div>
                <div class="bg-white p-6 rounded-xl border border-slate-100 h-32"></div>
                <div class="bg-white p-6 rounded-xl border border-slate-100 h-32"></div>
            </div>
            <div class="bg-white p-6 rounded-xl border border-slate-100 h-96"></div>
        </div>

        <!-- APP CONTENT (Oculto mientras carga) -->
        <div id="appContent" class="hidden">
            
            <!-- CONTROLES SUPERIORES Y TABS -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-8 flex flex-col xl:flex-row gap-4 items-end xl:items-center justify-between">
                
                <!-- TABS -->
                <div class="flex bg-slate-100 p-1 rounded-lg w-full md:w-auto">
                    <button onclick="setTab('dashboard')" id="tab-dashboard" class="tab-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2">
                        <i data-lucide="pie-chart" class="h-4 w-4"></i> Gráficos
                    </button>
                    <button onclick="setTab('table')" id="tab-table" class="tab-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2">
                        <i data-lucide="list" class="h-4 w-4"></i> Datos General
                    </button>
                    <button onclick="setTab('courses')" id="tab-courses" class="tab-btn flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2">
                        <i data-lucide="search" class="h-4 w-4"></i> Por Curso
                    </button>
                </div>

                <!-- FILTROS PRINCIPALES (Dashboard & Table) -->
                <div id="mainFilters" class="flex flex-col md:flex-row gap-4 w-full xl:w-2/3 justify-end items-end hidden">
                    <div class="w-full md:w-1/3">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Empresa</label>
                        <div class="relative">
                            <i data-lucide="briefcase" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400"></i>
                            <select id="filterCompany" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none"></select>
                        </div>
                    </div>
                    <div class="w-full md:w-1/3">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Área</label>
                        <div class="relative">
                            <i data-lucide="filter" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400"></i>
                            <select id="filterArea" class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none"></select>
                        </div>
                    </div>
                    <div class="w-full md:w-1/3 flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Buscar</label>
                            <div class="relative">
                                <i data-lucide="search" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400"></i>
                                <input type="text" id="searchTerm" placeholder="Buscar..." class="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" />
                            </div>
                        </div>
                        <button onclick="handleExport()" title="Exportar a Excel (.xls)" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg flex items-center justify-center transition-colors shadow-sm h-[42px] w-[42px] shrink-0">
                            <i data-lucide="download" class="h-5 w-5"></i>
                        </button>
                    </div>
                </div>

                <!-- FILTROS POR CURSO -->
                <div id="courseFilters" class="w-full xl:w-1/3 flex gap-2 items-end hidden">
                    <div class="flex-1">
                        <label class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Seleccionar Curso</label>
                        <div class="relative">
                            <i data-lucide="book-open" class="absolute left-3 top-2.5 h-4 w-4 text-slate-400"></i>
                            <select id="filterCourse" class="w-full pl-9 pr-4 py-2 bg-white border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm"></select>
                        </div>
                    </div>
                    <button id="btnExportCourse" onclick="handleExport()" disabled title="Exportar lista de este curso (.xls)" class="bg-green-600 hover:bg-green-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white p-2 rounded-lg flex items-center justify-center transition-colors shadow-sm h-[42px] w-[42px] shrink-0">
                        <i data-lucide="download" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>

            <!-- TAB CONTENT: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6 hidden">
                <div id="dashboardEmptyState" class="hidden"></div>
                <div id="dashboardContent">
                    <!-- KPI CARDS -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Total Solicitudes</p>
                                <h3 id="kpi-total" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-blue-100 rounded-lg text-blue-600"><i data-lucide="users" class="h-6 w-6"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Empresas Activas</p>
                                <h3 id="kpi-empresas" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="briefcase" class="h-6 w-6"></i></div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Áreas Activas</p>
                                <h3 id="kpi-areas" class="text-3xl font-bold text-slate-800 mt-1">0</h3>
                            </div>
                            <div class="p-2 bg-purple-100 rounded-lg text-purple-600"><i data-lucide="building-2" class="h-6 w-6"></i></div>
                        </div>
                        
                        <!-- TARJETA TOP CURSO -->
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <div class="flex justify-between items-start mb-2">
                                <div class="mr-4 w-full">
                                    <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Top Curso (P1)</p>
                                    <h3 id="kpi-top-course-name" class="text-base font-bold text-slate-800 mt-1 leading-tight min-h-[2.5rem]">N/A</h3>
                                </div>
                                <div class="p-2 bg-amber-100 rounded-lg text-amber-600 shrink-0"><i data-lucide="book-open" class="h-5 w-5"></i></div>
                            </div>
                            <div class="flex items-end justify-between mt-2 pt-2 border-t border-slate-100">
                                <div class="flex flex-col">
                                    <span class="text-xs text-slate-400 font-semibold mb-1">Total (P1+P2+P3)</span>
                                    <span id="kpi-top-course-total" class="text-2xl font-bold text-slate-800">0</span>
                                </div>
                                <div class="flex gap-1">
                                    <div class="flex flex-col items-center bg-red-50 px-2 py-1 rounded border border-red-100">
                                        <span class="text-[10px] font-bold text-red-600">P1</span>
                                        <span id="kpi-top-course-p1" class="text-xs font-bold text-red-700">0</span>
                                    </div>
                                    <div class="flex flex-col items-center bg-amber-50 px-2 py-1 rounded border border-amber-100">
                                        <span class="text-[10px] font-bold text-amber-600">P2</span>
                                        <span id="kpi-top-course-p2" class="text-xs font-bold text-amber-700">0</span>
                                    </div>
                                    <div class="flex flex-col items-center bg-emerald-50 px-2 py-1 rounded border border-emerald-100">
                                        <span class="text-[10px] font-bold text-emerald-600">P3</span>
                                        <span id="kpi-top-course-p3" class="text-xs font-bold text-emerald-700">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- GRÁFICO: TOP 5 CURSOS -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 mt-6">
                        <h3 class="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i data-lucide="book-open" class="h-6 w-6 text-amber-500"></i>
                            Top 5 Cursos Más Solicitados (Prioridad 1)
                        </h3>
                        <div class="relative h-80 w-full">
                            <canvas id="chartTopCourses"></canvas>
                        </div>
                    </div>

                    <!-- GRÁFICOS SECUNDARIOS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-base font-bold text-slate-700 mb-4">Solicitudes por Área</h3>
                            <div class="relative h-64 w-full">
                                <canvas id="chartArea"></canvas>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                            <h3 class="text-base font-bold text-slate-700 mb-4">Preferencia de Modalidad</h3>
                            <div class="relative h-64 w-full flex items-center justify-center">
                                <canvas id="chartModality"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB CONTENT: TABLA GENERAL -->
            <div id="view-table" class="hidden">
                <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-500">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                <tr>
                                    <th class="px-6 py-3">Empresa</th>
                                    <th class="px-6 py-3">Colaborador</th>
                                    <th class="px-6 py-3">Area</th>
                                    <th class="px-6 py-3">Curso P1</th>
                                    <th class="px-6 py-3">Curso P2</th>
                                    <th class="px-6 py-3">Curso P3</th>
                                </tr>
                            </thead>
                            <tbody id="generalTableBody">
                                <!-- Filas generadas por JS -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Paginación -->
                    <div id="generalPagination" class="flex items-center justify-between px-6 py-4 border-t bg-slate-50 hidden"></div>
                </div>
            </div>

            <!-- TAB CONTENT: POR CURSO -->
            <div id="view-courses" class="hidden space-y-4">
                <div id="courseSelectState" class="text-center py-20 bg-white rounded-xl border border-dashed border-slate-300 hidden">
                    <i data-lucide="book-open" class="h-12 w-12 text-slate-300 mx-auto mb-3"></i>
                    <h3 class="text-lg font-medium text-slate-600">Selecciona un curso</h3>
                    <p class="text-slate-400">Usa el selector de arriba para ver quiénes necesitan un curso específico.</p>
                </div>
                
                <div id="courseContent" class="space-y-4 hidden">
                    <!-- KPI Cursos -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-slate-500 uppercase">Total Interesados</p>
                                <p id="course-kpi-total" class="text-2xl font-bold text-slate-800">0</p>
                            </div>
                            <div class="bg-blue-100 p-2 rounded-lg text-blue-600"><i data-lucide="users" class="h-5 w-5"></i></div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-red-600 uppercase">Prioridad 1 (Alta)</p>
                                <p id="course-kpi-p1" class="text-2xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border-l-4 border-amber-500 shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-amber-600 uppercase">Prioridad 2 (Media)</p>
                                <p id="course-kpi-p2" class="text-2xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm flex items-center justify-between">
                            <div>
                                <p class="text-xs font-bold text-emerald-600 uppercase">Prioridad 3 (Baja)</p>
                                <p id="course-kpi-p3" class="text-2xl font-bold text-slate-800">0</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-4 border-b bg-slate-50 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700 flex items-center gap-2">
                                <span class="bg-blue-600 text-white px-2 py-1 rounded text-xs">Curso</span>
                                <span id="courseTableName"></span>
                            </h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                                    <tr>
                                        <th class="px-6 py-3">Prioridad</th>
                                        <th class="px-6 py-3">Empresa</th>
                                        <th class="px-6 py-3">Colaborador</th>
                                        <th class="px-6 py-3">Area</th>
                                        <th class="px-6 py-3">Cargo</th>
                                        <th class="px-6 py-3">Supervisor</th>
                                    </tr>
                                </thead>
                                <tbody id="courseTableBody">
                                    <!-- Generado por JS -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Paginación Cursos -->
                        <div id="coursePagination" class="flex items-center justify-between px-6 py-4 border-t bg-slate-50 hidden"></div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- SCRIPTS LÓGICA -->
    <script>
        // CONFIGURACIÓN
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTswu_UFbR0oMXr-CVN1dLfEEpB1UNUH2dhEHFxhw40E4gNO-Yt1EJYTE0z5DRwaFniA/exec';
        const ITEMS_PER_PAGE = 10;
        const CHART_COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ff6b6b', '#4ecdc4'];

        // ESTADO GLOBAL
        let rawData = [];
        let state = {
            tab: 'dashboard', // dashboard, table, courses
            filterCompany: 'Todas',
            filterArea: 'Todas',
            searchTerm: '',
            selectedCourse: '',
            currentPage: 1
        };
        
        // INSTANCIAS DE GRÁFICOS (Para poder destruirlos antes de redibujar)
        let chartInstances = { top: null, area: null, modality: null };

        // INICIALIZACIÓN DE ICONOS
        lucide.createIcons();

        // 1. OBTENER DATOS
        async function fetchData() {
            document.getElementById('skeletonLoader').classList.remove('hidden');
            document.getElementById('appContent').classList.add('hidden');
            document.getElementById('errorContainer').classList.add('hidden');

            try {
                const response = await fetch(SCRIPT_URL);
                const json = await response.json();
                
                if (Array.isArray(json)) {
                    rawData = json;
                    initApp();
                } else {
                    throw new Error("El formato de datos no es válido.");
                }
            } catch (err) {
                console.error(err);
                document.getElementById('errorMessage').innerText = err.message;
                document.getElementById('errorContainer').classList.remove('hidden');
                document.getElementById('skeletonLoader').classList.add('hidden');
            }
        }

        // 2. INICIALIZAR APP
        function initApp() {
            document.getElementById('skeletonLoader').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');

            populateDropdowns();
            attachEventListeners();
            render();
        }

        // 3. LLENAR SELECTORES (DROPDOWNS)
        function populateDropdowns() {
            // Extraer valores únicos
            const companies = ['Todas', ...new Set(rawData.map(d => d['Empresa']).filter(Boolean))].sort();
            const areas = ['Todas', ...new Set(rawData.map(d => d['Area']).filter(Boolean))].sort();
            
            const coursesSet = new Set();
            rawData.forEach(row => {
                if (row['Curso Prioridad 1']) coursesSet.add(row['Curso Prioridad 1']);
                if (row['Curso Prioridad 2']) coursesSet.add(row['Curso Prioridad 2']);
                if (row['Curso Prioridad 3']) coursesSet.add(row['Curso Prioridad 3']);
            });
            const courses = Array.from(coursesSet).sort();

            // Llenar HTML
            const selCompany = document.getElementById('filterCompany');
            selCompany.innerHTML = companies.map(c => `<option value="${c}">${c}</option>`).join('');
            
            const selArea = document.getElementById('filterArea');
            selArea.innerHTML = areas.map(a => `<option value="${a}">${a}</option>`).join('');
            
            const selCourse = document.getElementById('filterCourse');
            selCourse.innerHTML = `<option value="">-- Selecciona un curso --</option>` + 
                                  courses.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // 4. EVENT LISTENERS
        function attachEventListeners() {
            // Filtros Dashboard/Tabla
            document.getElementById('filterCompany').addEventListener('change', (e) => {
                state.filterCompany = e.target.value; state.currentPage = 1; render();
            });
            document.getElementById('filterArea').addEventListener('change', (e) => {
                state.filterArea = e.target.value; state.currentPage = 1; render();
            });
            
            // Buscador con debounce simple
            let timeout = null;
            document.getElementById('searchTerm').addEventListener('input', (e) => {
                clearTimeout(timeout);
                timeout = setTimeout(() => {
                    state.searchTerm = e.target.value.toLowerCase(); state.currentPage = 1; render();
                }, 300);
            });

            // Filtro Curso
            document.getElementById('filterCourse').addEventListener('change', (e) => {
                state.selectedCourse = e.target.value; state.currentPage = 1; 
                document.getElementById('btnExportCourse').disabled = !state.selectedCourse;
                render();
            });
        }

        // 5. CAMBIO DE PESTAÑAS (TABS)
        window.setTab = function(tabName) {
            state.tab = tabName;
            state.currentPage = 1;

            // Actualizar botones visualmente
            ['dashboard', 'table', 'courses'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if(t === tabName) {
                    btn.classList.replace('text-slate-500', 'text-blue-600');
                    btn.classList.replace('hover:text-slate-700', 'bg-white');
                    btn.classList.add('shadow-sm');
                } else {
                    btn.classList.replace('text-blue-600', 'text-slate-500');
                    btn.classList.replace('bg-white', 'hover:text-slate-700');
                    btn.classList.remove('shadow-sm');
                }
            });

            // Mostrar/Ocultar Filtros correctos
            if (tabName === 'courses') {
                document.getElementById('mainFilters').classList.add('hidden');
                document.getElementById('courseFilters').classList.remove('hidden');
                document.getElementById('courseFilters').classList.add('flex');
            } else {
                document.getElementById('mainFilters').classList.remove('hidden');
                document.getElementById('mainFilters').classList.add('flex');
                document.getElementById('courseFilters').classList.add('hidden');
                document.getElementById('courseFilters').classList.remove('flex');
            }

            // Mostrar/Ocultar Vistas
            ['dashboard', 'table', 'courses'].forEach(t => {
                document.getElementById(`view-${t}`).classList.toggle('hidden', t !== tabName);
            });

            render();
        }

        // 6. RENDERIZADO PRINCIPAL
        function render() {
            if (state.tab === 'dashboard') {
                renderDashboard();
            } else if (state.tab === 'table') {
                renderGeneralTable();
            } else if (state.tab === 'courses') {
                renderCourseView();
            }
            lucide.createIcons();
        }

        // --- LÓGICA DE DATOS ---
        function getProcessedData() {
            let data = rawData;
            if (state.filterArea !== 'Todas') data = data.filter(item => item['Area'] === state.filterArea);
            if (state.filterCompany !== 'Todas') data = data.filter(item => item['Empresa'] === state.filterCompany);
            if (state.searchTerm) {
                const term = state.searchTerm;
                data = data.filter(item => 
                    (item['Colaborador'] && item['Colaborador'].toLowerCase().includes(term)) ||
                    (item['Curso Prioridad 1'] && item['Curso Prioridad 1'].toLowerCase().includes(term)) ||
                    (item['Empresa'] && item['Empresa'].toLowerCase().includes(term))
                );
            }
            return data;
        }

        function getCourseViewData() {
            if (!state.selectedCourse) return [];
            const course = state.selectedCourse;
            
            return rawData.filter(row => 
                row['Curso Prioridad 1'] === course || 
                row['Curso Prioridad 2'] === course || 
                row['Curso Prioridad 3'] === course
            ).map(row => {
                let priority = '';
                if (row['Curso Prioridad 1'] === course) priority = 'P1 (Alta)';
                else if (row['Curso Prioridad 2'] === course) priority = 'P2 (Media)';
                else if (row['Curso Prioridad 3'] === course) priority = 'P3 (Baja)';
                return { ...row, foundPriority: priority };
            }).sort((a, b) => a.foundPriority.localeCompare(b.foundPriority));
        }

        // HTML ESTADO VACÍO GENERATOR
        function getEmptyStateHTML(title, message) {
            return `
                <div class="flex flex-col items-center justify-center py-16 px-4 text-center bg-white rounded-xl border border-dashed border-slate-300 w-full">
                    <div class="bg-slate-50 p-4 rounded-full mb-4">
                        <i data-lucide="file-question" class="h-10 w-10 text-slate-400"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-1">${title}</h3>
                    <p class="text-slate-500 max-w-sm text-sm">${message}</p>
                </div>
            `;
        }

        // --- RENDER DASHBOARD ---
        function renderDashboard() {
            const data = getProcessedData();
            
            const emptyStateContainer = document.getElementById('dashboardEmptyState');
            const contentContainer = document.getElementById('dashboardContent');

            if (data.length === 0) {
                emptyStateContainer.innerHTML = getEmptyStateHTML("No hay datos para mostrar", "No se encontraron registros que coincidan con los filtros seleccionados.");
                emptyStateContainer.classList.remove('hidden');
                contentContainer.classList.add('hidden');
                return;
            }

            emptyStateContainer.classList.add('hidden');
            contentContainer.classList.remove('hidden');

            // Calcular KPIs
            const uniqueEmpresas = new Set(data.map(d => d['Empresa']).filter(Boolean)).size;
            const uniqueAreas = new Set(data.map(d => d['Area']).filter(Boolean)).size;

            document.getElementById('kpi-total').innerText = data.length;
            document.getElementById('kpi-empresas').innerText = uniqueEmpresas;
            document.getElementById('kpi-areas').innerText = uniqueAreas;

            // Stats Cursos P1 para gráfico y KPI
            const courseCountsP1 = {};
            data.forEach(d => {
                const c = d['Curso Prioridad 1'];
                if(c) courseCountsP1[c] = (courseCountsP1[c] || 0) + 1;
            });
            const topCourses = Object.entries(courseCountsP1)
                .map(([name, count]) => ({ name, count }))
                .sort((a, b) => b.count - a.count)
                .slice(0, 5);

            // Top Curso KPI Detail
            const topCourseName = topCourses[0]?.name;
            let tcStats = { total: 0, p1: 0, p2: 0, p3: 0 };
            if (topCourseName) {
                data.forEach(d => {
                    if (d['Curso Prioridad 1'] === topCourseName) { tcStats.p1++; tcStats.total++; }
                    if (d['Curso Prioridad 2'] === topCourseName) { tcStats.p2++; tcStats.total++; }
                    if (d['Curso Prioridad 3'] === topCourseName) { tcStats.p3++; tcStats.total++; }
                });
            }

            document.getElementById('kpi-top-course-name').innerText = topCourseName || 'N/A';
            document.getElementById('kpi-top-course-total').innerText = tcStats.total;
            document.getElementById('kpi-top-course-p1').innerText = tcStats.p1;
            document.getElementById('kpi-top-course-p2').innerText = tcStats.p2;
            document.getElementById('kpi-top-course-p3').innerText = tcStats.p3;

            // Stats Areas
            const areaCounts = {};
            data.forEach(d => {
                const area = d['Area'] || 'Sin Area';
                areaCounts[area] = (areaCounts[area] || 0) + 1;
            });
            const areaData = Object.entries(areaCounts).map(([name, count]) => ({name, count})).sort((a,b) => b.count - a.count);

            // Stats Modalidad
            const modCounts = {};
            data.forEach(d => {
                const mod = d['Modalidad'] || 'No Definido';
                modCounts[mod] = (modCounts[mod] || 0) + 1;
            });

            // Dibujar Gráficos (Destruir anteriores si existen)
            drawTopCoursesChart(topCourses);
            drawAreaChart(areaData);
            drawModalityChart(modCounts);
        }

        // --- RENDER TABLES ---
        function renderGeneralTable() {
            const data = getProcessedData();
            const tbody = document.getElementById('generalTableBody');
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colSpan="6" class="px-6 py-12">${getEmptyStateHTML('No se encontraron resultados', 'No hay colaboradores que coincidan con tu búsqueda actual.')}</td></tr>`;
                document.getElementById('generalPagination').classList.add('hidden');
                return;
            }

            // Paginar
            const start = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const pagedData = data.slice(start, start + ITEMS_PER_PAGE);

            tbody.innerHTML = pagedData.map(row => `
                <tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4 font-semibold text-indigo-900">${row['Empresa'] || '-'}</td>
                    <td class="px-6 py-4 font-medium text-slate-900">
                        ${row['Colaborador']}
                        <div class="text-xs text-slate-400">${row['Cargo'] || ''}</div>
                    </td>
                    <td class="px-6 py-4">${row['Area'] || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded-full text-xs font-semibold inline-block whitespace-nowrap">
                            ${row['Curso Prioridad 1'] || '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-slate-600">${row['Curso Prioridad 2'] || '-'}</td>
                    <td class="px-6 py-4 text-slate-600">${row['Curso Prioridad 3'] || '-'}</td>
                </tr>
            `).join('');

            renderPaginationControl('generalPagination', data.length);
        }

        function renderCourseView() {
            const courseSelectState = document.getElementById('courseSelectState');
            const courseContent = document.getElementById('courseContent');
            
            if (!state.selectedCourse) {
                courseSelectState.classList.remove('hidden');
                courseContent.classList.add('hidden');
                return;
            }

            courseSelectState.classList.add('hidden');
            courseContent.classList.remove('hidden');

            const data = getCourseViewData();
            document.getElementById('courseTableName').innerText = state.selectedCourse;

            // KPIs Curso
            document.getElementById('course-kpi-total').innerText = data.length;
            document.getElementById('course-kpi-p1').innerText = data.filter(r => r.foundPriority.includes('P1')).length;
            document.getElementById('course-kpi-p2').innerText = data.filter(r => r.foundPriority.includes('P2')).length;
            document.getElementById('course-kpi-p3').innerText = data.filter(r => r.foundPriority.includes('P3')).length;

            const tbody = document.getElementById('courseTableBody');
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colSpan="6" class="px-6 py-12">${getEmptyStateHTML('Sin datos', 'Nadie ha solicitado este curso aún.')}</td></tr>`;
                document.getElementById('coursePagination').classList.add('hidden');
                return;
            }

            // Paginar
            const start = (state.currentPage - 1) * ITEMS_PER_PAGE;
            const pagedData = data.slice(start, start + ITEMS_PER_PAGE);

            tbody.innerHTML = pagedData.map(row => {
                let badgeClass = 'bg-green-50 text-green-700 border-green-200';
                if(row.foundPriority.includes('P1')) badgeClass = 'bg-red-50 text-red-700 border-red-200';
                else if(row.foundPriority.includes('P2')) badgeClass = 'bg-amber-50 text-amber-700 border-amber-200';

                return `
                <tr class="bg-white border-b hover:bg-slate-50">
                    <td class="px-6 py-4">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${badgeClass} inline-block whitespace-nowrap">
                            ${row.foundPriority}
                        </span>
                    </td>
                    <td class="px-6 py-4 font-semibold text-indigo-900">${row['Empresa'] || '-'}</td>
                    <td class="px-6 py-4 font-medium text-slate-900">${row['Colaborador']}</td>
                    <td class="px-6 py-4">${row['Area'] || '-'}</td>
                    <td class="px-6 py-4">${row['Cargo'] || '-'}</td>
                    <td class="px-6 py-4 text-slate-400">${row['Supervisor'] || '-'}</td>
                </tr>
            `}).join('');

            renderPaginationControl('coursePagination', data.length);
        }

        // --- PAGINATION CONTROL HTML ---
        window.changePage = function(dir) {
            state.currentPage += dir;
            render();
        }

        function renderPaginationControl(containerId, totalItems) {
            const container = document.getElementById(containerId);
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            
            if (totalPages <= 1) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            container.classList.add('flex'); // Asegurar layout flex
            
            const startItem = Math.min((state.currentPage - 1) * ITEMS_PER_PAGE + 1, totalItems);
            const endItem = Math.min(state.currentPage * ITEMS_PER_PAGE, totalItems);

            const prevDisabled = state.currentPage === 1 ? 'disabled class="p-2 rounded-md opacity-50 cursor-not-allowed text-slate-600"' : 'onclick="changePage(-1)" class="p-2 rounded-md hover:bg-slate-200 text-slate-600 cursor-pointer"';
            const nextDisabled = state.currentPage === totalPages ? 'disabled class="p-2 rounded-md opacity-50 cursor-not-allowed text-slate-600"' : 'onclick="changePage(1)" class="p-2 rounded-md hover:bg-slate-200 text-slate-600 cursor-pointer"';

            container.innerHTML = `
                <span class="text-sm text-slate-500">
                    Mostrando ${startItem} a ${endItem} de ${totalItems} resultados
                </span>
                <div class="flex items-center gap-2">
                    <button ${prevDisabled}><i data-lucide="chevron-left" class="h-4 w-4"></i></button>
                    <span class="text-sm font-medium text-slate-700">Página ${state.currentPage} de ${totalPages}</span>
                    <button ${nextDisabled}><i data-lucide="chevron-right" class="h-4 w-4"></i></button>
                </div>
            `;
        }

        // --- DIBUJO DE GRÁFICOS (Chart.js) ---
        function drawTopCoursesChart(data) {
            if (chartInstances.top) chartInstances.top.destroy();
            const ctx = document.getElementById('chartTopCourses').getContext('2d');
            
            chartInstances.top = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Solicitudes P1',
                        data: data.map(d => d.count),
                        backgroundColor: CHART_COLORS,
                        borderRadius: 6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            grid: { display: false, drawBorder: false },
                            ticks: { font: { size: 12, weight: 'bold' }, color: '#475569' }
                        }
                    }
                }
            });
        }

        function drawAreaChart(data) {
            if (chartInstances.area) chartInstances.area.destroy();
            const ctx = document.getElementById('chartArea').getContext('2d');
            
            chartInstances.area = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.name),
                    datasets: [{
                        label: 'Empleados',
                        data: data.map(d => d.count),
                        backgroundColor: '#94a3b8',
                        borderRadius: { topLeft: 4, topRight: 4 },
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false, drawBorder: false }, ticks: { font: { size: 11 } } },
                        y: { display: false }
                    }
                }
            });
        }

        function drawModalityChart(modCounts) {
            if (chartInstances.modality) chartInstances.modality.destroy();
            const ctx = document.getElementById('chartModality').getContext('2d');
            
            const labels = Object.keys(modCounts);
            const data = Object.values(modCounts);

            chartInstances.modality = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: CHART_COLORS,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });
        }

        // --- EXPORTAR A EXCEL (.xls trick) ---
        window.handleExport = function() {
            const dataToExport = state.tab === 'courses' ? getCourseViewData() : getProcessedData();
            if (!dataToExport || dataToExport.length === 0) return;

            const headers = Object.keys(dataToExport[0]).filter(k => k !== 'foundPriority');
            if (state.tab === 'courses') headers.unshift('foundPriority'); // Mover prioridad al principio si es curso

            let tableHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head>
            <meta charset="UTF-8">
            <style>
                table { border-collapse: collapse; width: 100%; font-family: sans-serif; }
                th { background-color: #1e3a8a; color: white; border: 1px solid #000; padding: 8px; font-weight: bold; text-align: left; }
                td { border: 1px solid #ccc; padding: 5px; }
            </style>
            </head>
            <body>
            <table>
                <thead>
                <tr>
                    ${headers.map(header => `<th>${header === 'foundPriority' ? 'Prioridad' : header}</th>`).join('')}
                </tr>
                </thead>
                <tbody>
                ${dataToExport.map(row => `
                    <tr>
                    ${headers.map(header => {
                        const val = row[header] !== undefined && row[header] !== null ? row[header] : '';
                        return `<td>${val}</td>`;
                    }).join('')}
                    </tr>
                `).join('')}
                </tbody>
            </table>
            </body>
            </html>
            `;

            const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            link.setAttribute('href', url);
            link.setAttribute('download', `reporte_dnc_${state.tab}_${timestamp}.xls`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- ARRANCAR APLICACIÓN ---
        // Establecer tab inicial visualmente
        setTab('dashboard');
        // Traer datos
        fetchData();

    </script>
</body>
</html>
