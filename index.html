import React, { useState, useEffect, useMemo } from 'react';
import { 
  BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
  PieChart, Pie, Cell 
} from 'recharts';
import { 
  Users, BookOpen, Building2, Monitor, Loader2, Briefcase, 
  Filter, Search, AlertCircle, List, ChevronLeft, ChevronRight, FileQuestion, Download
} from 'lucide-react';

// URL FIJA DEL SCRIPT (BACKEND)
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwTswu_UFbR0oMXr-CVN1dLfEEpB1UNUH2dhEHFxhw40E4gNO-Yt1EJYTE0z5DRwaFniA/exec';

// --- MOCK DATA FOR PREVIEW ---
const MOCK_DATA = [
  { "Empresa": "TechCorp", "Supervisor": "Juan Perez", "Colaborador": "Ana Silva", "RUN Colaborador": "11.111.111-1", "Area": "Ventas", "Cargo": "Ejecutivo", "Curso Prioridad 1": "Técnicas de Cierre", "Curso Prioridad 2": "Excel Avanzado", "Curso Prioridad 3": "Liderazgo", "Modalidad": "Online", "Sincronia": "Sincrónico" },
  { "Empresa": "TechCorp", "Supervisor": "Juan Perez", "Colaborador": "Pedro Diaz", "RUN Colaborador": "12.222.222-2", "Area": "Ventas", "Cargo": "Vendedor", "Curso Prioridad 1": "Negociación", "Curso Prioridad 2": "Inglés Básico", "Curso Prioridad 3": "CRM", "Modalidad": "Presencial", "Sincronia": "Asincrónico" },
  { "Empresa": "LogiTrans", "Supervisor": "Maria Gomez", "Colaborador": "Luis Torres", "RUN Colaborador": "13.333.333-3", "Area": "Operaciones", "Cargo": "Analista", "Curso Prioridad 1": "Excel Avanzado", "Curso Prioridad 2": "Power BI", "Curso Prioridad 3": "Python", "Modalidad": "Online", "Sincronia": "Asincrónico" },
  { "Empresa": "LogiTrans", "Supervisor": "Maria Gomez", "Colaborador": "Carla Ruiz", "RUN Colaborador": "14.444.444-4", "Area": "Operaciones", "Cargo": "Gerente", "Curso Prioridad 1": "Liderazgo Ágil", "Curso Prioridad 2": "Gestión de Tiempo", "Curso Prioridad 3": "Finanzas", "Modalidad": "Híbrido", "Sincronia": "Sincrónico" },
  { "Empresa": "Innovatech", "Supervisor": "Carlos Ruiz", "Colaborador": "Sofia M.", "RUN Colaborador": "15.555.555-5", "Area": "TI", "Cargo": "Desarrollador", "Curso Prioridad 1": "React JS", "Curso Prioridad 2": "Seguridad Informática", "Curso Prioridad 3": "AWS", "Modalidad": "Online", "Sincronia": "Asincrónico" },
  { "Empresa": "Innovatech", "Supervisor": "Carlos Ruiz", "Colaborador": "Jorge L.", "RUN Colaborador": "16.666.666-6", "Area": "TI", "Cargo": "Soporte", "Curso Prioridad 1": "Atención al Cliente", "Curso Prioridad 2": "Hardware", "Curso Prioridad 3": "Redes", "Modalidad": "Presencial", "Sincronia": "Sincrónico" },
  { "Empresa": "TechCorp", "Supervisor": "Juan Perez", "Colaborador": "Roberto Gomez", "RUN Colaborador": "17.777.777-7", "Area": "Ventas", "Cargo": "Junior", "Curso Prioridad 1": "Técnicas de Cierre", "Curso Prioridad 2": "Excel Básico", "Curso Prioridad 3": "Comunicación", "Modalidad": "Online", "Sincronia": "Asincrónico" },
  { "Empresa": "LogiTrans", "Supervisor": "Maria Gomez", "Colaborador": "Elena White", "RUN Colaborador": "18.888.888-8", "Area": "Operaciones", "Cargo": "Supervisor", "Curso Prioridad 1": "Liderazgo Ágil", "Curso Prioridad 2": "Power BI", "Curso Prioridad 3": "Inglés", "Modalidad": "Presencial", "Sincronia": "Sincrónico" },
];

const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ff6b6b', '#4ecdc4'];

const ITEMS_PER_PAGE = 10;

// --- COMPONENTE SKELETON ---
const DashboardSkeleton = () => (
  <div className="space-y-6 animate-pulse">
    {/* Filters Skeleton */}
    <div className="flex flex-col xl:flex-row gap-4 justify-between bg-white p-4 rounded-xl border border-slate-100">
       <div className="flex gap-4 w-full xl:w-2/3">
          <div className="h-10 bg-slate-200 rounded w-1/3"></div>
          <div className="h-10 bg-slate-200 rounded w-1/3"></div>
          <div className="h-10 bg-slate-200 rounded w-1/3"></div>
       </div>
       <div className="flex gap-2 w-full xl:w-auto">
          <div className="h-10 bg-slate-200 rounded w-24"></div>
          <div className="h-10 bg-slate-200 rounded w-24"></div>
          <div className="h-10 bg-slate-200 rounded w-24"></div>
       </div>
    </div>

    {/* KPI Skeleton */}
    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
      {[...Array(4)].map((_, i) => (
        <div key={i} className="bg-white p-6 rounded-xl border border-slate-100 h-32 flex justify-between">
          <div className="space-y-3 w-2/3">
            <div className="h-4 bg-slate-200 rounded w-full"></div>
            <div className="h-8 bg-slate-200 rounded w-1/2"></div>
          </div>
          <div className="h-12 w-12 bg-slate-200 rounded-lg"></div>
        </div>
      ))}
    </div>

    {/* Top Course Chart Skeleton */}
    <div className="bg-white p-6 rounded-xl border border-slate-100 h-96">
      <div className="h-6 bg-slate-200 rounded w-1/4 mb-6"></div>
      <div className="space-y-6">
        {[...Array(5)].map((_, i) => (
          <div key={i} className="flex gap-4 items-center">
             <div className="h-4 bg-slate-200 rounded w-32"></div>
             <div className="h-8 bg-slate-200 rounded w-full"></div>
          </div>
        ))}
      </div>
    </div>

    {/* Secondary Charts Skeleton */}
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div className="bg-white p-6 rounded-xl border border-slate-100 h-72">
         <div className="h-6 bg-slate-200 rounded w-1/3 mb-4"></div>
         <div className="h-full bg-slate-100 rounded"></div>
      </div>
      <div className="bg-white p-6 rounded-xl border border-slate-100 h-72">
         <div className="h-6 bg-slate-200 rounded w-1/3 mb-4"></div>
         <div className="h-full rounded-full bg-slate-100 w-48 h-48 mx-auto"></div>
      </div>
    </div>
  </div>
);

// --- COMPONENTE EMPTY STATE ---
const EmptyState = ({ title, message }: { title: string, message: string }) => (
  <div className="flex flex-col items-center justify-center py-16 px-4 text-center bg-white rounded-xl border border-dashed border-slate-300">
    <div className="bg-slate-50 p-4 rounded-full mb-4">
      <FileQuestion className="h-10 w-10 text-slate-400" />
    </div>
    <h3 className="text-lg font-bold text-slate-800 mb-1">{title}</h3>
    <p className="text-slate-500 max-w-sm text-sm">{message}</p>
  </div>
);

export default function DNCDashboard() {
  const [rawData, setRawData] = useState(MOCK_DATA);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [useMock, setUseMock] = useState(true);

  // Filters for Main Dashboard
  const [filterArea, setFilterArea] = useState('Todas');
  const [filterCompany, setFilterCompany] = useState('Todas');
  const [searchTerm, setSearchTerm] = useState('');

  // Filter for Course View
  const [selectedCourse, setSelectedCourse] = useState('');

  // PAGINATION STATE
  const [currentPage, setCurrentPage] = useState(1);

  // Fetch Data logic
  const fetchData = async () => {
    setLoading(true);
    setError(null);
    try {
      const response = await fetch(SCRIPT_URL);
      const json = await response.json();
      
      if (Array.isArray(json)) {
        setRawData(json);
        setUseMock(false);
      } else {
        throw new Error("El formato de los datos no es un array JSON válido.");
      }
    } catch (err) {
      console.error(err);
      setError("Error al cargar datos. " + err.message);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchData();
  }, []);

  // Reset pagination when filters change
  useEffect(() => {
    setCurrentPage(1);
  }, [filterArea, filterCompany, searchTerm, selectedCourse, activeTab]);

  // --- DATA PROCESSING FOR DASHBOARD ---
  const processedData = useMemo(() => {
    let data = rawData;
    if (filterArea !== 'Todas') data = data.filter(item => item['Area'] === filterArea);
    if (filterCompany !== 'Todas') data = data.filter(item => item['Empresa'] === filterCompany);
    if (searchTerm) {
      const lowerTerm = searchTerm.toLowerCase();
      data = data.filter(item => 
        (item['Colaborador'] && item['Colaborador'].toLowerCase().includes(lowerTerm)) ||
        (item['Curso Prioridad 1'] && item['Curso Prioridad 1'].toLowerCase().includes(lowerTerm)) ||
        (item['Empresa'] && item['Empresa'].toLowerCase().includes(lowerTerm))
      );
    }
    return data;
  }, [rawData, filterArea, filterCompany, searchTerm]);

  // --- DATA PROCESSING FOR COURSE VIEW ---
  const allUniqueCourses = useMemo(() => {
    const courses = new Set();
    rawData.forEach(row => {
      if (row['Curso Prioridad 1']) courses.add(row['Curso Prioridad 1']);
      if (row['Curso Prioridad 2']) courses.add(row['Curso Prioridad 2']);
      if (row['Curso Prioridad 3']) courses.add(row['Curso Prioridad 3']);
    });
    return Array.from(courses).sort();
  }, [rawData]);

  const courseViewData = useMemo(() => {
    if (!selectedCourse) return [];
    
    return rawData.filter(row => 
      row['Curso Prioridad 1'] === selectedCourse || 
      row['Curso Prioridad 2'] === selectedCourse || 
      row['Curso Prioridad 3'] === selectedCourse
    ).map(row => {
      let priority = '';
      if (row['Curso Prioridad 1'] === selectedCourse) priority = 'P1 (Alta)';
      else if (row['Curso Prioridad 2'] === selectedCourse) priority = 'P2 (Media)';
      else if (row['Curso Prioridad 3'] === selectedCourse) priority = 'P3 (Baja)';
      return { ...row, foundPriority: priority };
    }).sort((a, b) => a.foundPriority.localeCompare(b.foundPriority));
  }, [rawData, selectedCourse]);

  // Statistics
  const stats = useMemo(() => {
    const totalCollaborators = processedData.length;
    const areasList = ['Todas', ...new Set(rawData.map(d => d['Area']).filter(Boolean))];
    const companiesList = ['Todas', ...new Set(rawData.map(d => d['Empresa']).filter(Boolean))];
    const activeAreasCount = new Set(processedData.map(d => d['Area'])).size;
    const activeCompaniesCount = new Set(processedData.map(d => d['Empresa'])).size;
    
    // Calculate P1 counts
    const courseCountsP1 = {};
    processedData.forEach(d => {
      const course = d['Curso Prioridad 1'];
      if(course) courseCountsP1[course] = (courseCountsP1[course] || 0) + 1;
    });
    
    const sortedTopCourses = Object.entries(courseCountsP1)
        .map(([name, count]) => ({ name, count }))
        .sort((a, b) => b.count - a.count)
        .slice(0, 5);

    // Calculate detailed stats for the #1 Course
    const topCourseName = sortedTopCourses[0]?.name;
    let topCourseStats = { total: 0, p1: 0, p2: 0, p3: 0 };

    if (topCourseName) {
        processedData.forEach(d => {
            if (d['Curso Prioridad 1'] === topCourseName) { topCourseStats.p1++; topCourseStats.total++; }
            if (d['Curso Prioridad 2'] === topCourseName) { topCourseStats.p2++; topCourseStats.total++; }
            if (d['Curso Prioridad 3'] === topCourseName) { topCourseStats.p3++; topCourseStats.total++; }
        });
    }

    const modalityCounts = {};
    processedData.forEach(d => {
      const mod = d['Modalidad'] || 'No Definido';
      modalityCounts[mod] = (modalityCounts[mod] || 0) + 1;
    });

    return {
      total: totalCollaborators,
      areasCount: activeAreasCount,
      companiesCount: activeCompaniesCount,
      areasList,
      companiesList,
      topCourses: sortedTopCourses,
      topCourseDetail: { name: topCourseName, ...topCourseStats },
      modalities: Object.entries(modalityCounts)
        .map(([name, value]) => ({ name, value }))
    };
  }, [processedData, rawData]);

  const chartDataArea = useMemo(() => {
    const counts = {};
    processedData.forEach(d => {
      const area = d['Area'] || 'Sin Area';
      counts[area] = (counts[area] || 0) + 1;
    });
    return Object.entries(counts)
      .map(([name, count]) => ({ name, Empleados: count }))
      .sort((a, b) => b.Empleados - a.Empleados);
  }, [processedData]);

  // PAGINATION LOGIC
  const getPaginatedData = (data) => {
    const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
    return data.slice(startIndex, startIndex + ITEMS_PER_PAGE);
  };

  const PaginationControls = ({ totalItems }) => {
    const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
    
    if (totalPages <= 1) return null;

    return (
      <div className="flex items-center justify-between px-6 py-4 border-t bg-slate-50">
        <span className="text-sm text-slate-500">
          Mostrando {Math.min((currentPage - 1) * ITEMS_PER_PAGE + 1, totalItems)} a {Math.min(currentPage * ITEMS_PER_PAGE, totalItems)} de {totalItems} resultados
        </span>
        <div className="flex items-center gap-2">
          <button
            onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))}
            disabled={currentPage === 1}
            className="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed text-slate-600"
          >
            <ChevronLeft className="h-4 w-4" />
          </button>
          <span className="text-sm font-medium text-slate-700">
            Página {currentPage} de {totalPages}
          </span>
          <button
            onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))}
            disabled={currentPage === totalPages}
            className="p-2 rounded-md hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed text-slate-600"
          >
            <ChevronRight className="h-4 w-4" />
          </button>
        </div>
      </div>
    );
  };

  // --- EXPORT TO EXCEL (XLS HTML) LOGIC (MEJORA 7) ---
  const handleExport = () => {
    const dataToExport = activeTab === 'courses' ? courseViewData : processedData;
    
    if (!dataToExport || dataToExport.length === 0) return;

    // Obtener encabezados
    const headers = Object.keys(dataToExport[0]);
    
    // Crear tabla HTML
    let tableHTML = `
      <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
      <head>
      <!--[if gte mso 9]><xml><x:ExcelWorkbook><x:ExcelWorksheets><x:ExcelWorksheet><x:Name>Reporte DNC</x:Name><x:WorksheetOptions><x:DisplayGridlines/></x:WorksheetOptions></x:ExcelWorksheet></x:ExcelWorksheets></x:ExcelWorkbook></xml><![endif]-->
      <meta charset="UTF-8">
      <style>
        table { border-collapse: collapse; width: 100%; }
        th { background-color: #1e3a8a; color: white; border: 1px solid #000; padding: 5px; font-weight: bold; }
        td { border: 1px solid #ccc; padding: 5px; }
      </style>
      </head>
      <body>
      <table>
        <thead>
          <tr>
            ${headers.map(header => `<th>${header}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          ${dataToExport.map(row => `
            <tr>
              ${headers.map(header => {
                const val = row[header] !== undefined && row[header] !== null ? row[header] : '';
                return `<td>${val}</td>`;
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>
      </body>
      </html>
    `;

    // Crear Blob con tipo Excel
    const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
    link.setAttribute('href', url);
    link.setAttribute('download', `reporte_dnc_${activeTab}_${timestamp}.xls`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  return (
    <div className="min-h-screen bg-slate-50 text-slate-900 font-sans">
      {/* HEADER */}
      <header className="bg-blue-900 text-white shadow-lg">
        <div className="container mx-auto px-4 py-6">
          <div className="flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <BookOpen className="h-8 w-8 text-blue-300" />
                Dashboard DNC
              </h1>
              <p className="text-blue-200 text-sm">Detección de Necesidades de Capacitación</p>
            </div>
          </div>
        </div>
      </header>

      <main className="container mx-auto px-4 py-8">
        
        {loading ? (
           <DashboardSkeleton />
        ) : (
          <>
            {error && (
              <div className="mb-6 bg-red-50 border-l-4 border-red-500 p-4 rounded text-red-700 flex items-start gap-3">
                <AlertCircle className="h-5 w-5 mt-0.5" />
                <div>
                  <p className="font-bold">Error de conexión</p>
                  <p className="text-sm">{error}</p>
                </div>
              </div>
            )}

            {/* TOP CONTROLS & TABS */}
            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-8 flex flex-col xl:flex-row gap-4 items-end xl:items-center justify-between">
              {/* TABS SELECTOR */}
              <div className="flex bg-slate-100 p-1 rounded-lg w-full md:w-auto">
                <button 
                  onClick={() => setActiveTab('dashboard')}
                  className={`flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2 ${activeTab === 'dashboard' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <PieChart className="h-4 w-4" />
                  Gráficos
                </button>
                <button 
                  onClick={() => setActiveTab('table')}
                  className={`flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2 ${activeTab === 'table' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <List className="h-4 w-4" />
                  Datos General
                </button>
                <button 
                  onClick={() => setActiveTab('courses')}
                  className={`flex-1 md:flex-none px-4 py-2 text-sm font-medium rounded-md transition-all flex items-center justify-center gap-2 ${activeTab === 'courses' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                >
                  <Search className="h-4 w-4" />
                  Por Curso
                </button>
              </div>

              {/* DYNAMIC FILTERS & EXPORT BUTTON */}
              {activeTab !== 'courses' ? (
                <div className="flex flex-col md:flex-row gap-4 w-full xl:w-2/3 justify-end items-end">
                  <div className="w-full md:w-1/3">
                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Empresa</label>
                    <div className="relative">
                      <Briefcase className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                      <select 
                        className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none"
                        value={filterCompany}
                        onChange={(e) => setFilterCompany(e.target.value)}
                      >
                        {stats.companiesList.map(comp => (
                          <option key={comp} value={comp}>{comp}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div className="w-full md:w-1/3">
                    <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Área</label>
                    <div className="relative">
                      <Filter className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                      <select 
                        className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none appearance-none"
                        value={filterArea}
                        onChange={(e) => setFilterArea(e.target.value)}
                      >
                        {stats.areasList.map(area => (
                          <option key={area} value={area}>{area}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                  <div className="w-full md:w-1/3 flex gap-2">
                    <div className="flex-1">
                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Buscar</label>
                        <div className="relative">
                        <Search className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                        <input 
                            type="text" 
                            placeholder="Buscar..." 
                            className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                        </div>
                    </div>
                    {/* BOTÓN DE EXPORTAR EXCEL */}
                    <button 
                        onClick={handleExport}
                        title="Exportar a Excel (.xls)"
                        className="bg-green-600 hover:bg-green-700 text-white p-2 rounded-lg flex items-center justify-center transition-colors shadow-sm h-[42px] w-[42px] shrink-0"
                    >
                        <Download className="h-5 w-5" />
                    </button>
                  </div>
                </div>
              ) : (
                 <div className="w-full xl:w-1/3 flex gap-2 items-end">
                    <div className="flex-1">
                        <label className="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-1 block">Seleccionar Curso</label>
                        <div className="relative">
                        <BookOpen className="absolute left-3 top-2.5 h-4 w-4 text-slate-400" />
                        <select 
                            className="w-full pl-9 pr-4 py-2 bg-white border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none shadow-sm"
                            value={selectedCourse}
                            onChange={(e) => setSelectedCourse(e.target.value)}
                        >
                            <option value="">-- Selecciona un curso para ver detalles --</option>
                            {allUniqueCourses.map((course, idx) => (
                            <option key={idx} value={course}>{course}</option>
                            ))}
                        </select>
                        </div>
                    </div>
                    {/* BOTÓN DE EXPORTAR EXCEL (CURSOS) */}
                    <button 
                        onClick={handleExport}
                        disabled={!selectedCourse}
                        title="Exportar lista de este curso (.xls)"
                        className="bg-green-600 hover:bg-green-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white p-2 rounded-lg flex items-center justify-center transition-colors shadow-sm h-[42px] w-[42px] shrink-0"
                    >
                        <Download className="h-5 w-5" />
                    </button>
                 </div>
              )}
            </div>

            {/* CONTENT SWITCHER */}
            {activeTab === 'dashboard' && (
              <div className="space-y-6">
                
                {/* CHECK FOR EMPTY STATE IN DASHBOARD */}
                {processedData.length === 0 ? (
                  <EmptyState 
                    title="No hay datos para mostrar" 
                    message="No se encontraron registros que coincidan con los filtros seleccionados. Intenta cambiar la empresa, el área o el término de búsqueda." 
                  />
                ) : (
                  <>
                    {/* KPI CARDS */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500">Total Solicitudes</p>
                            <h3 className="text-3xl font-bold text-slate-800 mt-1">{stats.total}</h3>
                          </div>
                          <div className="p-2 bg-blue-100 rounded-lg text-blue-600">
                            <Users className="h-6 w-6" />
                          </div>
                        </div>
                      </div>
                      
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500">Empresas Activas</p>
                            <h3 className="text-3xl font-bold text-slate-800 mt-1">{stats.companiesCount}</h3>
                          </div>
                          <div className="p-2 bg-indigo-100 rounded-lg text-indigo-600">
                            <Briefcase className="h-6 w-6" />
                          </div>
                        </div>
                      </div>

                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-start">
                          <div>
                            <p className="text-sm font-medium text-slate-500">Áreas Activas</p>
                            <h3 className="text-3xl font-bold text-slate-800 mt-1">{stats.areasCount}</h3>
                          </div>
                          <div className="p-2 bg-purple-100 rounded-lg text-purple-600">
                            <Building2 className="h-6 w-6" />
                          </div>
                        </div>
                      </div>

                      {/* TARJETA TOP CURSO */}
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <div className="flex justify-between items-start mb-2">
                          <div className="mr-4">
                            <p className="text-xs font-medium text-slate-500 uppercase tracking-wide">Top Curso</p>
                            <h3 className="text-base font-bold text-slate-800 mt-1 leading-tight min-h-[2.5rem]">
                              {stats.topCourseDetail.name || 'N/A'}
                            </h3>
                          </div>
                          <div className="p-2 bg-amber-100 rounded-lg text-amber-600 shrink-0">
                            <BookOpen className="h-5 w-5" />
                          </div>
                        </div>
                        
                        {stats.topCourseDetail.name && (
                            <div className="flex items-end justify-between mt-2 pt-2 border-t border-slate-100">
                                <div className="flex flex-col">
                                  <span className="text-xs text-slate-400 font-semibold mb-1">Interesados Total</span>
                                  <span className="text-2xl font-bold text-slate-800">{stats.topCourseDetail.total}</span>
                                </div>
                                <div className="flex gap-1">
                                    <div className="flex flex-col items-center bg-red-50 px-2 py-1 rounded border border-red-100">
                                        <span className="text-[10px] font-bold text-red-600">P1</span>
                                        <span className="text-xs font-bold text-red-700">{stats.topCourseDetail.p1}</span>
                                    </div>
                                    <div className="flex flex-col items-center bg-amber-50 px-2 py-1 rounded border border-amber-100">
                                        <span className="text-[10px] font-bold text-amber-600">P2</span>
                                        <span className="text-xs font-bold text-amber-700">{stats.topCourseDetail.p2}</span>
                                    </div>
                                    <div className="flex flex-col items-center bg-emerald-50 px-2 py-1 rounded border border-emerald-100">
                                        <span className="text-[10px] font-bold text-emerald-600">P3</span>
                                        <span className="text-xs font-bold text-emerald-700">{stats.topCourseDetail.p3}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                      </div>
                    </div>

                    {/* BIG CHART: TOP 5 COURSES */}
                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2">
                          <BookOpen className="h-6 w-6 text-amber-500"/>
                          Top 5 Cursos Más Solicitados (Prioridad 1)
                        </h3>
                        <div className="h-96 w-full">
                          <ResponsiveContainer width="100%" height="100%">
                            <BarChart 
                              data={stats.topCourses} 
                              layout="vertical"
                              margin={{ top: 5, right: 30, left: 40, bottom: 5 }}
                            >
                              <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                              <XAxis type="number" hide />
                              <YAxis 
                                dataKey="name" 
                                type="category" 
                                width={200}
                                tick={{fontSize: 12, fontWeight: 600, fill: '#475569'}}
                              />
                              <Tooltip 
                                contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} 
                                cursor={{fill: 'transparent'}}
                              />
                              <Bar dataKey="count" radius={[0, 6, 6, 0]} barSize={40}>
                                {stats.topCourses.map((entry, index) => (
                                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                              </Bar>
                            </BarChart>
                          </ResponsiveContainer>
                        </div>
                    </div>

                    {/* SECONDARY CHARTS ROW */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* AREA CHART */}
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="text-base font-bold text-slate-700 mb-4">Solicitudes por Área</h3>
                        <div className="h-64 w-full">
                          <ResponsiveContainer width="100%" height="100%">
                            <BarChart data={chartDataArea} margin={{ top: 5, right: 30, left: 20, bottom: 5 }}>
                              <CartesianGrid strokeDasharray="3 3" vertical={false} />
                              <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 11}} interval={0} />
                              <YAxis axisLine={false} tickLine={false} fontSize={11}/>
                              <Tooltip contentStyle={{ borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }} />
                              <Bar dataKey="Empleados" fill="#94a3b8" radius={[4, 4, 0, 0]} barSize={30} />
                            </BarChart>
                          </ResponsiveContainer>
                        </div>
                      </div>

                      {/* PIE CHART */}
                      <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                        <h3 className="text-base font-bold text-slate-700 mb-4">Preferencia de Modalidad</h3>
                        <div className="h-64 w-full flex items-center justify-center">
                          <ResponsiveContainer width="100%" height="100%">
                            <PieChart>
                              <Pie
                                data={stats.modalities}
                                cx="50%"
                                cy="50%"
                                innerRadius={50}
                                outerRadius={70}
                                paddingAngle={5}
                                dataKey="value"
                              >
                                {stats.modalities.map((entry, index) => (
                                  <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                                ))}
                              </Pie>
                              <Tooltip />
                              <Legend verticalAlign="bottom" height={36}/>
                            </PieChart>
                          </ResponsiveContainer>
                        </div>
                      </div>
                    </div>
                  </>
                )}
              </div>
            )}

            {activeTab === 'table' && (
              <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                 <div className="overflow-x-auto">
                  <table className="w-full text-sm text-left text-slate-500">
                    <thead className="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                      <tr>
                        <th className="px-6 py-3">Empresa</th>
                        <th className="px-6 py-3">Colaborador</th>
                        <th className="px-6 py-3">Area</th>
                        <th className="px-6 py-3">Curso P1</th>
                        <th className="px-6 py-3">Curso P2</th>
                        <th className="px-6 py-3">Curso P3</th>
                      </tr>
                    </thead>
                    <tbody>
                      {getPaginatedData(processedData).length > 0 ? (
                        getPaginatedData(processedData).map((row, index) => (
                          <tr key={index} className="bg-white border-b hover:bg-slate-50">
                            <td className="px-6 py-4 font-semibold text-indigo-900">{row['Empresa'] || '-'}</td>
                            <td className="px-6 py-4 font-medium text-slate-900">
                              {row['Colaborador']}
                              <div className="text-xs text-slate-400">{row['Cargo']}</div>
                            </td>
                            <td className="px-6 py-4">{row['Area']}</td>
                            <td className="px-6 py-4">
                              <span className="bg-blue-50 text-blue-700 px-2 py-1 rounded-full text-xs font-semibold block w-fit">
                                {row['Curso Prioridad 1']}
                              </span>
                            </td>
                            <td className="px-6 py-4 text-slate-600">{row['Curso Prioridad 2'] || '-'}</td>
                            <td className="px-6 py-4 text-slate-600">{row['Curso Prioridad 3'] || '-'}</td>
                          </tr>
                        ))
                      ) : (
                        <tr>
                          <td colSpan={6} className="px-6 py-12">
                             {/* MEJORA 5: Empty State in Table */}
                             <EmptyState 
                                title="No se encontraron resultados" 
                                message="No hay colaboradores que coincidan con tu búsqueda actual." 
                             />
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
                {/* PAGINATION CONTROLS */}
                {processedData.length > 0 && (
                  <PaginationControls totalItems={processedData.length} />
                )}
              </div>
            )}

            {activeTab === 'courses' && (
               <div className="space-y-4">
                 {!selectedCourse ? (
                   <div className="text-center py-20 bg-white rounded-xl border border-dashed border-slate-300">
                     <BookOpen className="h-12 w-12 text-slate-300 mx-auto mb-3" />
                     <h3 className="text-lg font-medium text-slate-600">Selecciona un curso</h3>
                     <p className="text-slate-400">Usa el selector de arriba para ver quiénes necesitan un curso específico.</p>
                   </div>
                 ) : (
                    <>
                     <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                           <div>
                              <p className="text-xs font-bold text-slate-500 uppercase">Total Interesados</p>
                              <p className="text-2xl font-bold text-slate-800">{courseViewData.length}</p>
                           </div>
                           <div className="bg-blue-100 p-2 rounded-lg text-blue-600">
                              <Users className="h-5 w-5" />
                           </div>
                        </div>
                        
                        <div className="bg-white p-4 rounded-xl border-l-4 border-red-500 shadow-sm flex items-center justify-between">
                           <div>
                              <p className="text-xs font-bold text-red-600 uppercase">Prioridad 1 (Alta)</p>
                              <p className="text-2xl font-bold text-slate-800">
                                {courseViewData.filter(r => r.foundPriority.includes('P1')).length}
                              </p>
                           </div>
                        </div>

                        <div className="bg-white p-4 rounded-xl border-l-4 border-amber-500 shadow-sm flex items-center justify-between">
                           <div>
                              <p className="text-xs font-bold text-amber-600 uppercase">Prioridad 2 (Media)</p>
                              <p className="text-2xl font-bold text-slate-800">
                                {courseViewData.filter(r => r.foundPriority.includes('P2')).length}
                              </p>
                           </div>
                        </div>

                        <div className="bg-white p-4 rounded-xl border-l-4 border-emerald-500 shadow-sm flex items-center justify-between">
                           <div>
                              <p className="text-xs font-bold text-emerald-600 uppercase">Prioridad 3 (Baja)</p>
                              <p className="text-2xl font-bold text-slate-800">
                                {courseViewData.filter(r => r.foundPriority.includes('P3')).length}
                              </p>
                           </div>
                        </div>
                     </div>

                     <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                       <div className="p-4 border-b bg-slate-50 flex justify-between items-center">
                         <h3 className="font-bold text-slate-700 flex items-center gap-2">
                           <span className="bg-blue-600 text-white px-2 py-1 rounded text-xs">Curso</span>
                           {selectedCourse}
                         </h3>
                       </div>
                       <div className="overflow-x-auto">
                         <table className="w-full text-sm text-left text-slate-500">
                           <thead className="text-xs text-slate-700 uppercase bg-slate-50 border-b">
                             <tr>
                               <th className="px-6 py-3">Prioridad</th>
                               <th className="px-6 py-3">Empresa</th>
                               <th className="px-6 py-3">Colaborador</th>
                               <th className="px-6 py-3">Area</th>
                               <th className="px-6 py-3">Cargo</th>
                               <th className="px-6 py-3">Supervisor</th>
                             </tr>
                           </thead>
                           <tbody>
                             {getPaginatedData(courseViewData).length > 0 ? (
                               getPaginatedData(courseViewData).map((row, index) => (
                                 <tr key={index} className="bg-white border-b hover:bg-slate-50">
                                   <td className="px-6 py-4">
                                     <span className={`px-3 py-1 rounded-full text-xs font-bold border ${
                                       row.foundPriority.includes('P1') 
                                         ? 'bg-red-50 text-red-700 border-red-200' 
                                         : row.foundPriority.includes('P2') 
                                           ? 'bg-amber-50 text-amber-700 border-amber-200' 
                                           : 'bg-green-50 text-green-700 border-green-200'
                                     }`}>
                                       {row.foundPriority}
                                     </span>
                                   </td>
                                   <td className="px-6 py-4 font-semibold text-indigo-900">{row['Empresa'] || '-'}</td>
                                   <td className="px-6 py-4 font-medium text-slate-900">{row['Colaborador']}</td>
                                   <td className="px-6 py-4">{row['Area']}</td>
                                   <td className="px-6 py-4">{row['Cargo']}</td>
                                   <td className="px-6 py-4 text-slate-400">{row['Supervisor']}</td>
                                 </tr>
                               ))
                             ) : (
                               <tr>
                                 <td colSpan={6} className="px-6 py-12">
                                    {/* MEJORA 5: Empty State in Course View Table */}
                                    <EmptyState 
                                        title="Sin datos" 
                                        message="Nadie ha solicitado este curso aún." 
                                     />
                                 </td>
                               </tr>
                             )}
                           </tbody>
                         </table>
                       </div>
                        {/* PAGINATION CONTROLS FOR COURSES TAB */}
                        {courseViewData.length > 0 && (
                            <PaginationControls totalItems={courseViewData.length} />
                        )}
                     </div>
                   </>
                 )}
               </div>
            )}
          </>
        )}
      </main>
    </div>
  );
}
